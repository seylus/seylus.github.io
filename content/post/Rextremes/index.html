---
title: "[R] Plotting results from extRemes package - Extreme Value Analysis"
date: 2017-02-06T00:00:00
tags: [R, extremes, return level, plotting, EVA, Statistics, PhD]
---



<p><img src="/post/Rextremes/returnlevel.png" /></p>
<p>If you are familiar with Extreme Value Analysis (EVA) in R you will have likely come across the <a href="https://cran.r-project.org/web/packages/extRemes/extRemes.pdf">extRemes package, written by Eric Gilleland</a>. While I am not (yet!) an expert in EVA, I have found this package to be quite accessible.</p>
<p>The package’s main function, <strong>‘fevd()’</strong>, fits an extreme value distribution to data. Methods for plotting are available for objects of class ‘fevd’ to produce diagnostics and result plots, such as a return level plot.</p>
<p>My issue is the restricted control you seem to have over the plot’s layout and general look. You can choose which plots to show, or to add a custom title, but not much else. What if you want to customise the plot to your liking, plot the results in another software/package or display two EVAs on the same figure as shown above?</p>
<p>I could not find an easy way to extract the information the package uses to generate the plots, nor could I find any mention of this problem online. In the off-chance someone is in the same situation, you’ll find a solution below. It seems a little awkward to me and if there is a better way that I am missing, please do let me know!</p>
<p>Let’s use the data from the “extRemes” package, with the example for the Peaks Over Threshold approach:</p>
<pre class="r"><code>library(extRemes)
data(&quot;damage&quot;, package = &quot;extRemes&quot;)
fitD &lt;- fevd(Dam, damage, threshold = 6, type = &quot;GP&quot;, time.units = &quot;2.06/year&quot;)
plot(fitD, type = &quot;rl&quot;)</code></pre>
<p><img src="/post/Rextremes/index_files/figure-html/load%20data-1.png" width="672" /></p>
<p>You have to play with the original code for the package’s plot functions. When using the Maximum Likelihood Estimation (MLE) method, the function to change is <strong>‘plot.fevd.mle’</strong>. If you are satisfied with the overall default aspect of the plots and just need to tweak it you can customise the code and reload the function. However, I generally use <strong>ggplot2</strong> to produce my figures and like to have a consistent template.</p>
<p>Once you have your <strong>‘fevd’</strong> object you will get the information you need to draw a Return Level plot with the following two functions (other types of plots and distributions will use a different section from <strong>plot.fevd.mle</strong>).</p>
<p>The first returns a dataframe of return level point coordinates:</p>
<pre class="r"><code>getrlpoints &lt;- function(fit){

xp2 &lt;- ppoints(fit$n, a = 0)
ytmp &lt;- datagrabber(fit)
y &lt;- c(ytmp[, 1])
sdat &lt;- sort(y)
npy &lt;- fit$npy
u &lt;- fit$threshold
rlpoints.x &lt;- -1/log(xp2)[sdat &gt; u]/npy
rlpoints.y &lt;- sdat[sdat &gt; u]
rlpoints &lt;- data.frame(rlpoints.x, rlpoints.y)

return(rlpoints)
}</code></pre>
<p>The second returns a dataframe of estimated returned levels with confidence intervals:</p>
<pre class="r"><code>getcidf &lt;- function(fit){

rperiods = c(2, 5, 10, 20, 50, 80, 100, 120, 200, 250, 300, 500, 800)
bds &lt;- ci(fit, return.period = rperiods)
c1 &lt;- as.numeric(bds[,1])
c2 &lt;- as.numeric(bds[,2])
c3 &lt;- as.numeric(bds[,3])
ci_df &lt;- data.frame(c1, c2, c3, rperiods) 

return(ci_df)
}</code></pre>
<p>That is all you need to produce the plot in <strong>ggplot2</strong>:</p>
<pre class="r"><code>library(ggplot2)

rlpoints &lt;- getrlpoints(fitD)
ci_df &lt;- getcidf(fitD)

ggplot() +
  geom_line(data = ci_df, aes(x = rperiods, y = c2), color = &quot;red&quot;) +
  geom_line(data = ci_df, aes(x = rperiods, y = c1), color = &quot;grey&quot;) +
  geom_line(data = ci_df, aes(x = rperiods, y = c3), color = &quot;grey&quot;) +
  geom_point(data = rlpoints, aes(x = rlpoints.x, y = rlpoints.y), size = 1) +
  ylab(&quot;Return Level (m)&quot;) +
  xlab(&quot;Return Period (Years)&quot;) +
  scale_x_log10(expand = c(0, 0), breaks = c(2,5,10,20,50,100,200,500)) +
  theme_bw() +
  theme(axis.text = element_text(size=12), axis.title = element_text(size = 14, face = &quot;bold&quot;))</code></pre>
<p><img src="/post/Rextremes/index_files/figure-html/plot%20returnlevels-1.png" width="672" /></p>
